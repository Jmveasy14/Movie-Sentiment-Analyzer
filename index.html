<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMetrics | Cinematic Market Intelligence</title>
    
    <!-- PyScript Core -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* --- PALETTE: Deep Space Fintech --- */
            --bg-deep: #030303;
            --bg-subtle: #0a0a0a;
            --panel-glass: rgba(255, 255, 255, 0.03);
            --panel-border: rgba(255, 255, 255, 0.08);
            --panel-border-hover: rgba(255, 255, 255, 0.15);
            
            --accent: #28db85; /* Signal Green */
            --accent-dim: rgba(40, 219, 133, 0.1);
            --neg: #ff3366;     /* Signal Red */
            --neg-dim: rgba(255, 51, 102, 0.1);
            --neutral: #3b82f6; /* Blue for neutral/extra charts */
            
            --text-main: #ffffff;
            --text-muted: #737373;
            --text-dim: #404040;
            
            --ease: cubic-bezier(0.23, 1, 0.32, 1);
        }

        * { box-sizing: border-box; outline: none; scrollbar-width: none; }
        *::-webkit-scrollbar { display: none; }

        body {
            margin: 0;
            background: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- LAYOUT --- */
        .app-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            width: 100%;
            height: 100%;
        }

        /* --- LEFT SIDEBAR --- */
        .sidebar {
            background: var(--bg-subtle);
            border-right: 1px solid var(--panel-border);
            padding: 32px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            z-index: 10;
            overflow-y: auto;
        }

        .brand {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .brand::before { content:''; width:8px; height:8px; background:var(--accent); border-radius:50%; box-shadow: 0 0 12px var(--accent); }

        .control-group { display: flex; flex-direction: column; gap: 20px; }
        
        label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
            display: block;
        }

        input, textarea {
            width: 100%;
            background: var(--panel-glass);
            border: 1px solid var(--panel-border);
            color: var(--text-main);
            padding: 14px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            transition: all 0.3s var(--ease);
        }
        input:focus, textarea:focus {
            border-color: var(--accent);
            background: rgba(40, 219, 133, 0.02);
            box-shadow: 0 0 0 4px rgba(40, 219, 133, 0.05);
        }

        .btn-main {
            background: var(--text-main);
            color: #000;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: transform 0.2s var(--ease);
        }
        .btn-main:hover { transform: scale(1.02); }
        .btn-main:active { transform: scale(0.98); }

        .nlp-stage {
            min-height: 80px;
            padding: 12px;
            border: 1px dashed var(--panel-border);
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-muted);
        }
        .tag-pos { color: var(--accent); }
        .tag-neg { color: var(--neg); }

        /* --- DASHBOARD --- */
        .dashboard {
            position: relative;
            overflow-y: auto;
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .dashboard::before {
            content: ''; position: fixed; top: -20%; right: -10%; width: 800px; height: 800px;
            background: radial-gradient(circle, rgba(40, 219, 133, 0.03), transparent 60%);
            pointer-events: none; z-index: 0;
        }

        /* 1. METRICS ROW */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            z-index: 1;
        }

        .metric-card {
            background: var(--panel-glass);
            border: 1px solid var(--panel-border);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .metric-head { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
        .metric-val { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 500; }
        .metric-status { font-size: 10px; color: var(--accent); margin-top: 4px; display: block; }

        /* 2. MAIN SCATTER CHART */
        .chart-main-section {
            height: 380px;
            border: 1px solid var(--panel-border);
            border-radius: 16px;
            position: relative;
            background: radial-gradient(circle at 50% 100%, rgba(255,255,255,0.02), transparent);
            overflow: hidden;
            z-index: 1;
        }

        /* 3. SECONDARY CHARTS ROW (Bar & Pie) */
        .secondary-charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            height: 300px;
            z-index: 1;
        }
        
        .chart-box {
            background: var(--panel-glass);
            border: 1px solid var(--panel-border);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        canvas { width: 100%; height: 100%; display: block; }
        
        .chart-label {
            position: absolute;
            top: 20px; left: 20px;
            font-size: 12px; font-weight: 600;
            color: var(--text-muted);
            display: flex; align-items: center; gap: 8px;
            z-index: 5;
            pointer-events: none;
        }
        .live-dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* 4. DATA TABLE */
        .data-section { z-index: 1; margin-bottom: 40px; }
        
        .section-header { 
            display: flex; justify-content: space-between; align-items: flex-end; 
            margin-bottom: 20px; border-bottom: 1px solid var(--panel-border); padding-bottom: 16px;
        }
        .section-title { font-size: 16px; font-weight: 600; }
        .section-sub { font-size: 12px; color: var(--text-muted); }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .data-table th {
            text-align: left;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            padding: 12px 16px;
            border-bottom: 1px solid var(--panel-border);
        }

        .data-table td {
            padding: 16px;
            color: var(--text-main);
            border-bottom: 1px solid var(--panel-border);
            transition: background 0.2s;
        }

        .data-row:hover td { background: var(--panel-glass); }

        .cell-movie { font-weight: 600; }
        .cell-rev { font-family: 'JetBrains Mono', monospace; color: var(--text-muted); }
        .cell-sent { font-family: 'JetBrains Mono', monospace; font-weight: 600; }
        .sent-high { color: var(--accent); }
        .sent-low { color: var(--neg); }
        .sent-mid { color: var(--text-muted); }

        .kw-pill {
            display: inline-block; padding: 4px 8px; background: rgba(255,255,255,0.05);
            border-radius: 4px; font-size: 11px; color: var(--text-muted); margin-right: 4px; margin-bottom: 4px;
        }
        .kw-pill.pos { background: var(--accent-dim); color: var(--accent); }
        .kw-pill.neg { background: var(--neg-dim); color: var(--neg); }

        /* Tooltip */
        .tooltip {
            position: absolute; pointer-events: none; background: rgba(10, 10, 10, 0.9);
            border: 1px solid var(--panel-border); padding: 12px; border-radius: 8px;
            font-size: 12px; z-index: 100; opacity: 0; transition: opacity 0.1s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

    </style>

    <script>
        // --- 1. DATA CORE ---
        window.appState = {
            movies: [
                { title: "Barbie", revenue: 1445, text: "A candy-colored masterpiece. Margot Robbie is amazing and the movie is funny, smart, and beautiful. A true success.", sentiment: 5.00 },
                { title: "Oppenheimer", revenue: 955, text: "A cinematic triumph. Cillian Murphy is brilliant in this intense, terrifying, and visually stunning look at history.", sentiment: 5.00 },
                { title: "The Marvels", revenue: 206, text: "It has fun moments and great chemistry, but the plot is messy and the villain is weak and forgettable.", sentiment: 1.58 },
                { title: "Morbius", revenue: 167, text: "A soulless, confused disaster. The visual effects are ugly, the story makes no sense, and it is boring. A total waste.", sentiment: -5.00 },
                { title: "Five Nights at Freddy's", revenue: 291, text: "Strictly for the fans. The animatronics are cool, but the movie is silly and lacks real horror or scares.", sentiment: -1.58 },
                { title: "Avatar: Way of Water", revenue: 2320, text: "Visually breathtaking and immersive. The story is simple, but the world is beautiful and the action is spectacular.", sentiment: 5.00 },
                { title: "Dune", revenue: 700, text: "A solid adaptation but feels incomplete.", sentiment: 0.00 }
            ],
            regression: { slope: 0, intercept: 0, r2: 0, isReady: false }
        };

        const sentimentDict = {
            "masterpiece": 4, "amazing": 4, "funny": 2, "smart": 2, "beautiful": 3, "success": 3,
            "triumph": 4, "brilliant": 4, "intense": 1, "terrifying": -1, "stunning": 4,
            "fun": 2, "great": 3, "messy": -2, "weak": -2, "forgettable": -2,
            "soulless": -3, "confused": -2, "disaster": -4, "ugly": -3, "boring": -3, "waste": -3,
            "cool": 2, "silly": -1, "lacks": -2, "breathtaking": 5, "immersive": 3, "spectacular": 3, "horror": -1
        };

        // --- 2. LOGIC ENGINE ---
        function analyze(text) {
            const tokens = text.toLowerCase().match(/\b(\w+)\b/g) || [];
            let score = 0;
            let keywords = [];
            tokens.forEach(t => { 
                if(sentimentDict[t]) {
                    score += sentimentDict[t];
                    keywords.push({ word: t, val: sentimentDict[t] });
                }
            });
            let norm = tokens.length > 0 ? (score / Math.sqrt(tokens.length)) * 2 : 0;
            return { score: Math.max(-5, Math.min(5, norm)), keywords: keywords };
        }

        function renderTable() {
            const tbody = document.getElementById('data-body');
            tbody.innerHTML = '';
            window.appState.movies.forEach(m => {
                const analysis = analyze(m.text);
                const displayScore = m.sentiment !== undefined ? m.sentiment : analysis.score;
                const tr = document.createElement('tr');
                tr.className = 'data-row';
                let scoreClass = 'sent-mid';
                if(displayScore > 2) scoreClass = 'sent-high';
                if(displayScore < -1) scoreClass = 'sent-low';
                const kwHtml = analysis.keywords.map(k => `<span class="kw-pill ${k.val > 0 ? 'pos' : 'neg'}">${k.word}</span>`).join('');
                tr.innerHTML = `<td class="cell-movie">${m.title}</td><td class="cell-rev">$${m.revenue}M</td><td class="cell-sent ${scoreClass}">${displayScore.toFixed(2)}</td><td>${kwHtml || '<span style="opacity:0.3">-</span>'}</td>`;
                tbody.appendChild(tr);
            });
        }

        function renderMetrics() {
            document.getElementById('m-count').innerText = window.appState.movies.length;
        }

        function addEntry() {
            const t = document.getElementById('in-title').value;
            const r = parseFloat(document.getElementById('in-rev').value);
            const txt = document.getElementById('in-text').value;
            if(!t || isNaN(r) || !txt) return;
            const res = analyze(txt);
            window.appState.movies.push({ title: t, revenue: r, text: txt, sentiment: res.score });
            document.getElementById('in-title').value = '';
            document.getElementById('in-rev').value = '';
            document.getElementById('in-text').value = '';
            document.getElementById('nlp-preview').innerHTML = 'Waiting for input...';
            
            // Update ALL Charts
            renderTable();
            renderMetrics();
            window.mainChart.sync();
            window.barChart.sync();
            window.pieChart.sync();
            if(window.run_py) window.run_py();
        }

        // --- 3. VISUALIZATION ENGINES ---
        
        // A. SCATTER CHART
        class ScatterChart {
            constructor() {
                this.cvs = document.getElementById('viz-scatter');
                this.ctx = this.cvs.getContext('2d');
                this.points = [];
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.cvs.addEventListener('mousemove', e => this.hover(e));
                requestAnimationFrame(() => this.loop());
            }
            resize() {
                const p = this.cvs.parentElement.getBoundingClientRect();
                this.dpr = window.devicePixelRatio || 1;
                this.cvs.width = p.width * this.dpr; this.cvs.height = p.height * this.dpr;
                this.ctx.scale(this.dpr, this.dpr);
                this.w = p.width; this.h = p.height;
                this.sync();
            }
            sync() {
                const maxRev = Math.max(...window.appState.movies.map(m=>m.revenue)) * 1.1;
                this.points = window.appState.movies.map(m => {
                    const tx = 60 + ((m.sentiment - -6) / 12) * (this.w - 120);
                    const ty = this.h - 60 - (m.revenue / maxRev) * (this.h - 120);
                    let c = '#737373';
                    if(m.sentiment > 1) c = '#28db85'; if(m.sentiment < -1) c = '#ff3366';
                    return { x: tx, y: this.h, tx, ty, r: 0, tr: 6 + (m.revenue/maxRev)*12, color: c, data: m };
                });
            }
            hover(e) {
                const r = this.cvs.getBoundingClientRect();
                const mx = e.clientX - r.left; const my = e.clientY - r.top;
                this.hit = this.points.find(p => Math.hypot(mx-p.x, my-p.y) < p.r+10);
                const tip = document.getElementById('tooltip');
                if(this.hit) {
                    tip.style.opacity = 1; tip.style.left = (e.clientX+15)+'px'; tip.style.top = (e.clientY+15)+'px';
                    tip.innerHTML = `<strong style="color:${this.hit.color}">${this.hit.data.title}</strong><br>Sentiment: ${this.hit.data.sentiment.toFixed(2)}<br>Revenue: $${this.hit.data.revenue}M`;
                    this.cvs.style.cursor = 'pointer';
                } else { tip.style.opacity = 0; this.cvs.style.cursor = 'default'; }
            }
            loop() {
                this.ctx.clearRect(0,0,this.w, this.h);
                this.ctx.strokeStyle = 'rgba(255,255,255,0.03)'; this.ctx.lineWidth = 1;
                const x0 = 60 + ((0 - -6) / 12) * (this.w - 120);
                this.ctx.beginPath(); this.ctx.moveTo(x0, 40); this.ctx.lineTo(x0, this.h-40); this.ctx.stroke();
                if(window.appState.regression.isReady) {
                    const {slope, intercept} = window.appState.regression;
                    const maxRev = Math.max(...window.appState.movies.map(m=>m.revenue)) * 1.1;
                    const px1 = 60 + ((-6 - -6)/12)*(this.w-120); const py1 = this.h-60 - ((slope*-6+intercept)/maxRev)*(this.h-120);
                    const px2 = 60 + ((6 - -6)/12)*(this.w-120); const py2 = this.h-60 - ((slope*6+intercept)/maxRev)*(this.h-120);
                    this.ctx.beginPath(); this.ctx.moveTo(px1, py1); this.ctx.lineTo(px2, py2);
                    this.ctx.strokeStyle = '#fff'; this.ctx.lineWidth = 2; this.ctx.setLineDash([4,4]); this.ctx.stroke(); this.ctx.setLineDash([]);
                }
                for(let p of this.points) {
                    p.x+=(p.tx-p.x)*0.1; p.y+=(p.ty-p.y)*0.1; p.r+=((this.hit===p?p.tr*1.5:p.tr)-p.r)*0.1;
                    this.ctx.fillStyle=p.color; this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); this.ctx.fill();
                }
                requestAnimationFrame(() => this.loop());
            }
        }

        // B. BAR CHART (Revenue)
        class BarChart {
            constructor() {
                this.cvs = document.getElementById('viz-bar');
                this.ctx = this.cvs.getContext('2d');
                this.resize(); window.addEventListener('resize', ()=>this.resize());
                requestAnimationFrame(()=>this.loop());
            }
            resize() {
                const p = this.cvs.parentElement.getBoundingClientRect();
                this.dpr = window.devicePixelRatio||1;
                this.cvs.width=p.width*this.dpr; this.cvs.height=p.height*this.dpr;
                this.ctx.scale(this.dpr, this.dpr);
                this.w=p.width; this.h=p.height;
                this.sync();
            }
            sync() {
                // Sort by revenue desc
                const sorted = [...window.appState.movies].sort((a,b)=>b.revenue-a.revenue).slice(0, 5); // Top 5
                const max = Math.max(...sorted.map(m=>m.revenue));
                this.bars = sorted.map((m, i) => {
                    const bw = (this.w - 40) / 5; 
                    const bh = (m.revenue/max) * (this.h - 60);
                    return { 
                        x: 20 + i*bw + 5, 
                        y: this.h - 20, 
                        w: bw - 10, 
                        th: bh, 
                        h: 0,
                        color: '#3b82f6',
                        title: m.title 
                    };
                });
            }
            loop() {
                this.ctx.clearRect(0,0,this.w,this.h);
                if(!this.bars) return;
                this.bars.forEach(b => {
                    b.h += (b.th - b.h)*0.1;
                    // Bar
                    const grad = this.ctx.createLinearGradient(0, b.y - b.h, 0, b.y);
                    grad.addColorStop(0, b.color); grad.addColorStop(1, 'rgba(59, 130, 246, 0.1)');
                    this.ctx.fillStyle = grad;
                    this.ctx.fillRect(b.x, b.y - b.h, b.w, b.h);
                    // Label
                    this.ctx.fillStyle = '#555';
                    this.ctx.font = '10px Inter';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(b.title.substring(0,10), b.x + b.w/2, b.y - b.h - 5);
                });
                requestAnimationFrame(()=>this.loop());
            }
        }

        // C. PIE CHART (Sentiment Dist)
        class PieChart {
            constructor() {
                this.cvs = document.getElementById('viz-pie');
                this.ctx = this.cvs.getContext('2d');
                this.resize(); window.addEventListener('resize', ()=>this.resize());
                requestAnimationFrame(()=>this.loop());
            }
            resize() {
                const p = this.cvs.parentElement.getBoundingClientRect();
                this.dpr = window.devicePixelRatio||1;
                this.cvs.width=p.width*this.dpr; this.cvs.height=p.height*this.dpr;
                this.ctx.scale(this.dpr, this.dpr);
                this.w=p.width; this.h=p.height;
                this.sync();
            }
            sync() {
                let pos=0, neg=0, neu=0;
                window.appState.movies.forEach(m => {
                    if(m.sentiment > 1) pos++;
                    else if(m.sentiment < -1) neg++;
                    else neu++;
                });
                const total = window.appState.movies.length;
                this.slices = [
                    { v: pos/total, c: '#28db85', l: 'Pos' },
                    { v: neg/total, c: '#ff3366', l: 'Neg' },
                    { v: neu/total, c: '#3b82f6', l: 'Neu' }
                ];
                this.curAngles = [0,0,0];
            }
            loop() {
                this.ctx.clearRect(0,0,this.w,this.h);
                if(!this.slices) return;
                let start = -Math.PI/2;
                const cx = this.w/2; const cy = this.h/2; const r = Math.min(cx,cy)*0.6;
                
                this.slices.forEach((s, i) => {
                    const target = s.v * Math.PI * 2;
                    this.curAngles[i] += (target - this.curAngles[i]) * 0.05;
                    
                    if(this.curAngles[i] > 0.01) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(cx,cy);
                        this.ctx.arc(cx, cy, r, start, start + this.curAngles[i]);
                        this.ctx.fillStyle = s.c;
                        this.ctx.fill();
                        start += this.curAngles[i];
                    }
                });
                
                // Donut Hole
                this.ctx.beginPath();
                this.ctx.arc(cx, cy, r*0.6, 0, Math.PI*2);
                this.ctx.fillStyle = '#0a0a0a'; 
                this.ctx.fill();
                
                this.ctx.fillStyle = '#fff';
                this.ctx.textAlign = 'center';
                this.ctx.font = '10px Inter';
                this.ctx.fillText("RATIO", cx, cy+4);

                requestAnimationFrame(()=>this.loop());
            }
        }

        // --- INIT ---
        window.onload = () => {
            renderTable();
            renderMetrics();
            
            window.mainChart = new ScatterChart();
            window.barChart = new BarChart();
            window.pieChart = new PieChart();
            
            // Live Type Preview
            document.getElementById('in-text').addEventListener('input', (e) => {
                const res = analyze(e.target.value);
                const html = e.target.value.split(' ').map(w => {
                    const c = w.toLowerCase().replace(/[^a-z]/g,'');
                    const v = sentimentDict[c];
                    if(v>0) return `<span class="tag-pos">${w}</span>`;
                    if(v<0) return `<span class="tag-neg">${w}</span>`;
                    return w;
                }).join(' ');
                document.getElementById('nlp-preview').innerHTML = html || 'Waiting for input...';
            });
        };
    </script>
</head>
<body>

    <div class="app-container">
        
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="brand">CineMetrics</div>
            
            <div class="control-group">
                <div>
                    <label>Movie Asset</label>
                    <input type="text" id="in-title" placeholder="Title (e.g. Dune Part Two)">
                </div>
                <div>
                    <label>Global Revenue ($M)</label>
                    <input type="number" id="in-rev" placeholder="0000">
                </div>
                <div>
                    <label>Audience Consensus</label>
                    <textarea id="in-text" rows="4" placeholder="Paste review text here..."></textarea>
                </div>
                <div>
                    <label>Sentiment Extraction</label>
                    <div id="nlp-preview" class="nlp-stage">Waiting for input...</div>
                </div>
                <button class="btn-main" onclick="addEntry()"> Enter </button>
            </div>
        </aside>

        <!-- DASHBOARD -->
        <main class="dashboard">
            
            <!-- 1. METRICS -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-head">Data Points</div>
                    <div class="metric-val" id="m-count">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-head">Correlation (r)</div>
                    <div class="metric-val" id="m-corr">--</div>
                    <span class="metric-status">Calculating...</span>
                </div>
                <div class="metric-card">
                    <div class="metric-head">Regression (RÂ²)</div>
                    <div class="metric-val" id="m-r2">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-head">System Status</div>
                    <div class="metric-val" id="sys-status" style="color:var(--accent)">Init</div>
                </div>
            </div>

            <!-- 2. MAIN SCATTER CHART -->
            <div class="chart-main-section">
                <div class="chart-label">
                    <div class="live-dot"></div> Market Regression Model
                </div>
                <canvas id="viz-scatter"></canvas>
                <div id="tooltip" class="tooltip"></div>
            </div>

            <!-- 3. SECONDARY CHARTS (NEW) -->
            <div class="secondary-charts-grid">
                <div class="chart-box">
                    <div class="chart-label">Top Revenue Assets</div>
                    <canvas id="viz-bar"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-label">Sentiment Ratio</div>
                    <canvas id="viz-pie"></canvas>
                </div>
            </div>

            <!-- 4. DATA TABLE -->
            <div class="data-section">
                <div class="section-header">
                    <div>
                        <div class="section-title">Live Data Stream</div>
                        <div class="section-sub">Real-time sentiment ingestion & processing</div>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Asset Name</th>
                            <th>Revenue</th>
                            <th>Sentiment Score</th>
                            <th>Keywords Detected</th>
                        </tr>
                    </thead>
                    <tbody id="data-body">
                        <!-- Injected by JS -->
                    </tbody>
                </table>
            </div>

        </main>
    </div>

    <!-- PYTHON KERNEL -->
    <py-config>
        packages = ["pandas"]
    </py-config>

    <py-script>
        import pandas as pd
        from pyscript import window
        from js import document, appState, window as js_window

        def run_py():
            try:
                document.getElementById('sys-status').innerText = "Processing..."
                document.getElementById('sys-status').style.color = "#f1c40f"

                data = appState.movies.to_py()
                if not data or len(data) < 2: return

                df = pd.DataFrame(data)
                
                # Math
                corr = df['revenue'].corr(df['sentiment'])
                
                # Linear Reg (Manual for speed)
                X = df['sentiment']
                Y = df['revenue']
                mx, my = X.mean(), Y.mean()
                num = ((X-mx)*(Y-my)).sum()
                den = ((X-mx)**2).sum()
                slope = num/den if den != 0 else 0
                icept = my - slope*mx
                
                # R2
                yp = slope*X + icept
                ss_res = ((Y-yp)**2).sum()
                ss_tot = ((Y-my)**2).sum()
                r2 = 1 - ss_res/ss_tot if ss_tot != 0 else 0

                # Update JS State
                js_window.updateStats(slope, icept, r2, corr)

                # Update UI
                document.getElementById('m-corr').innerText = f"{corr:.3f}"
                document.getElementById('m-r2').innerText = f"{r2:.3f}"
                document.getElementById('sys-status').innerText = "Optimal"
                document.getElementById('sys-status').style.color = "#28db85"

            except Exception as e:
                print(e)

        window.run_py = run_py
        run_py()
    </py-script>

    <script>
        window.updateStats = (m, b, r2, corr) => {
            window.appState.regression = { slope: m, intercept: b, r2, isReady: true };
            if(window.mainChart) window.mainChart.sync();
        }
    </script>
</body>
</html>